{% extends "base.html" %}

{% block content %}
<!-- Deaths by Day Chart -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Mortes por Dia (últimos 30 dias)</h5>
    </div>
    <div class="card-body">
        <canvas id="deathsChart" style="height: 300px;"></canvas>
    </div>
</div>

<h2 class="mb-4">Incidentes</h2>
<div class="table-container">
    <div class="table-responsive">
        <table id="incidents-table" class="table table-hover sources-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Título</th>
                    <th>Data</th>
                    <th>Local</th>
                    <th>Resumo</th>
                    <th>Fontes</th>
                    <th>Vítimas</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be loaded via DataTables AJAX -->
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof $ === 'undefined') {
        console.error('jQuery is not loaded');
        return;
    }
    
    // Initialize deaths chart
    fetch('/api/data/deaths-by-day?days=30')
        .then(response => response.json())
        .then(chartData => {
            const dates = chartData.data.map(item => {
                // Format date from YYYY-MM-DD to DD/MM
                const date = new Date(item.date);
                return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            });
            const deaths = chartData.data.map(item => item.deaths);
            
            const ctx = document.getElementById('deathsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Mortes',
                        data: deaths,
                        backgroundColor: 'rgba(220, 53, 69, 0.8)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Mortes: ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
        });
    
    // Initialize DataTable
    $('#incidents-table').DataTable({
        serverSide: true,
        ajax: {
            url: '/api/data/incidents',
            type: 'GET'
        },
        columns: [
            {
                data: 'id',
                render: function(data, type, row) {
                    return '<a href="/incident/' + data + '" class="link-primary">' + data + '</a>';
                }
            },
            {
                data: 'title',
                render: function(data, type, row) {
                    return '<a href="/incident/' + row.id + '" class="text-decoration-none text-dark fw-semibold">' + 
                           (data || '-') + '</a>';
                }
            },
            { data: 'date' },
            { data: 'location' },
            {
                data: 'description',
                className: 'summary-cell'
            },
            { data: 'source_count' },
            {
                data: 'death_count',
                render: function(data, type, row) {
                    return '<strong>' + (data !== null && data !== undefined ? data : 0) + '</strong>';
                }
            }
        ],
        order: [[2, 'desc']], // Default sort by date descending
        pageLength: 25,
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
        },
        responsive: true
    });
});
</script>
{% endblock %}