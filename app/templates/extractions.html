{% extends "base.html" %}

{% block content %}
<h2 class="mb-2">Eventos</h2>
<p class="text-muted mb-4">Eventos extraídos de fontes de notícias</p>

<div class="table-container">
    <div class="table-responsive">
        <table id="extractions-table" class="table table-hover sources-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Vítima</th>
                    <th>Localização</th>
                    <th>Data</th>
                    <th>Mortos</th>
                    <th>Confiança</th>
                    <th>Resumo</th>
                    <th>Fonte</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be loaded via DataTables AJAX -->
            </tbody>
        </table>
    </div>
</div>

<!-- Extraction Details Modal -->
<div class="modal fade" id="extraction-modal" tabindex="-1" aria-labelledby="extractionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="extractionModalLabel">Detalhes do Evento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="extraction-modal-body"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Re-extraction Result Modal -->
<div class="modal fade" id="re-extract-modal" tabindex="-1" aria-labelledby="reExtractModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reExtractModalLabel">Resultado da Re-extração</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="re-extract-content"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Store extraction data in a global object (populated from DataTables)
    var extractionData = {};
    var extractionsTable;

    document.addEventListener('DOMContentLoaded', function() {
        if (typeof $ === 'undefined') {
            console.error('jQuery is not loaded');
            return;
        }
        extractionsTable = $('#extractions-table').DataTable({
            serverSide: true,
            ajax: {
                url: '/api/data/extractions',
                type: 'GET',
                dataSrc: function(json) {
                    // Store extraction data for modal functionality
                    extractionData = {};
                    json.data.forEach(function(row) {
                        extractionData[row.id] = {
                            id: row.id,
                            victim_name: row.victim_name,
                            location: row.location,
                            date: row.date,
                            death_count: row.death_count,
                            confidence: row.confidence_score,
                            summary: row.summary_full || row.summary,
                            source: row.source,
                            incident_id: row.incident_id
                        };
                    });
                    return json.data;
                }
            },
            columns: [
                { data: 'id' },
                {
                    data: 'victim_name',
                    render: function(data, type, row) {
                        if (data) {
                            return '<strong>' + data + '</strong>';
                        }
                        return '<span class="text-muted">Desconhecido</span>';
                    }
                },
                {
                    data: 'location',
                    render: function(data, type, row) {
                        return data || '—';
                    }
                },
                {
                    data: 'date',
                    render: function(data, type, row) {
                        return data || '—';
                    }
                },
                {
                    data: 'death_count',
                    render: function(data, type, row) {
                        if (data !== null && data !== undefined) {
                            return '<strong>' + data + '</strong>';
                        }
                        return '<span class="text-muted">—</span>';
                    }
                },
                {
                    data: 'confidence_score',
                    render: function(data, type, row) {
                        var confidenceClass = 'low';
                        if (data >= 0.8) confidenceClass = 'high';
                        else if (data >= 0.5) confidenceClass = 'medium';
                        return '<span class="confidence-badge confidence-' + confidenceClass + '">' +
                               Math.round(data * 100) + '%</span>';
                    }
                },
                {
                    data: 'summary',
                    className: 'summary-cell',
                    render: function(data, type, row) {
                        return data || '—';
                    }
                },
                {
                    data: 'source_title',
                    render: function(data, type, row) {
                        if (data && row.source_url) {
                            var shortTitle = data.length > 30 ? data.substring(0, 30) + '...' : data;
                            return '<a href="' + row.source_url + '" target="_blank" rel="noopener noreferrer" ' +
                                   'title="' + data + '" onclick="event.stopPropagation();" class="link-primary">' +
                                   shortTitle + '</a>';
                        }
                        return '—';
                    }
                },
                {
                    data: 'source_id',
                    orderable: false,
                    render: function(data, type, row) {
                        if (data) {
                            return '<button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); reExtract(' +
                                   data + ', ' + row.id + ')" id="btn-re-extract-' + row.id + '" title="Re-extrair da fonte">' +
                                   'Re-extrair</button>';
                        }
                        return '—';
                    }
                }
            ],
            order: [[5, 'desc']], // Default sort by confidence_score descending
            pageLength: 25,
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
            },
            responsive: true,
            drawCallback: function() {
                // Make rows clickable
                $('#extractions-table tbody tr').css('cursor', 'pointer');
                $('#extractions-table tbody tr').off('click').on('click', function() {
                    var data = extractionsTable.row(this).data();
                    if (data) {
                        showExtractionDetails(data.id);
                    }
                });
            }
        });
    });

    function showExtractionDetails(extractionId) {
        const data = extractionData[extractionId];
        if (!data) return;

        const modalElement = document.getElementById('extraction-modal');
        const modal = new bootstrap.Modal(modalElement);
        const body = document.getElementById('extraction-modal-body');

        let html = '';

        // Extraction Information
        html += '<div class="extraction-section mb-4">';
        html += '<h5 class="mb-3">Informações Extraídas</h5>';
        html += '<table class="table table-sm">';
        html += `<tr><th style="width: 30%;">ID do Evento</th><td>${data.id}</td></tr>`;
        html += `<tr><th>Nome da Vítima</th><td>${data.victim_name || '—'}</td></tr>`;
        html += `<tr><th>Localização</th><td>${data.location || '—'}</td></tr>`;
        html += `<tr><th>Data</th><td>${data.date || '—'}</td></tr>`;
        html += `<tr><th>Mortos</th><td>${data.death_count !== null && data.death_count !== undefined ? data.death_count : '—'}</td></tr>`;
        html += `<tr><th>Confiança</th><td><span class="confidence-badge confidence-${data.confidence >= 0.8 ? 'high' : (data.confidence >= 0.5 ? 'medium' : 'low')}">${Math.round(data.confidence * 100)}%</span></td></tr>`;
        html += `<tr><th>Resumo</th><td>${data.summary || '—'}</td></tr>`;
        if (data.incident_id) {
            html += `<tr><th>Incidente Relacionado</th><td><a href="/incident/${data.incident_id}" class="link-primary">Ver Incidente #${data.incident_id}</a></td></tr>`;
        }
        html += '</table>';
        html += '</div>';

        // Source Information
        if (data.source) {
            html += '<div class="extraction-section mb-4">';
            html += '<h5 class="mb-3">Artigo Fonte</h5>';
            html += '<table class="table table-sm">';
            html += `<tr><th style="width: 30%;">Título</th><td>${data.source.title || '—'}</td></tr>`;
            html += `<tr><th>Tipo de Fonte</th><td><span class="badge badge-type">${data.source.source_type || 'unknown'}</span></td></tr>`;
            html += `<tr><th>Status</th><td><span class="badge badge-${data.source.status || 'pending'}">${data.source.status || 'pending'}</span></td></tr>`;
            if (data.source.published_at) {
                html += `<tr><th>Publicado em</th><td>${data.source.published_at}</td></tr>`;
            }
            if (data.source.fetched_at) {
                html += `<tr><th>Capturado em</th><td>${data.source.fetched_at}</td></tr>`;
            }
            html += `<tr><th>URL Original</th><td><a href="${data.source.url}" target="_blank" rel="noopener noreferrer" class="link-primary">${data.source.url}</a></td></tr>`;
            if (data.source.resolved_url && data.source.resolved_url !== data.source.url) {
                html += `<tr><th>URL Resolvida</th><td><a href="${data.source.resolved_url}" target="_blank" rel="noopener noreferrer" class="link-primary">${data.source.resolved_url}</a></td></tr>`;
            }
            html += '</table>';
            html += '</div>';

            // Full Article Content
            if (data.source.content) {
                html += '<div class="extraction-section">';
                html += '<h5 class="mb-3">Conteúdo Completo do Artigo</h5>';
                html += '<div id="article-content-' + extractionId + '" class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto; white-space: pre-wrap; line-height: 1.6; font-size: 0.95em;"></div>';
                html += '</div>';
            } else {
                html += '<div class="extraction-section">';
                html += '<p class="text-muted">Conteúdo do artigo não disponível.</p>';
                html += '</div>';
            }
        } else {
            html += '<div class="extraction-section">';
            html += '<p class="text-muted">Informações da fonte não disponíveis.</p>';
            html += '</div>';
        }

        body.innerHTML = html;
        modal.show();
        
        // Set content safely using textContent to prevent XSS
        if (data.source && data.source.content) {
            const contentEl = document.getElementById('article-content-' + extractionId);
            if (contentEl) {
                contentEl.textContent = data.source.content;
            }
        }
    }


    // Re-extract functionality
    async function reExtract(sourceId, extractionId) {
        const btn = document.getElementById(`btn-re-extract-${extractionId}`);
        if (!btn) return;

        const originalText = btn.textContent;
        btn.textContent = 'Extracting...';
        btn.disabled = true;

        try {
            const url = `/api/extract/${sourceId}?force=true`;
            console.log('Calling re-extraction API:', url);
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            console.log('Response status:', response.status, response.statusText);

            if (!response.ok) {
                // Try to get error message from response
                let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.message || errorData.error || errorMessage;
                } catch (e) {
                    // If response isn't JSON, try to get text
                    try {
                        const text = await response.text();
                        if (text && text.length > 0) {
                            errorMessage = text.substring(0, 200); // Limit error message length
                        }
                    } catch (textError) {
                        // If we can't read the response, use the status
                        errorMessage = `Server returned ${response.status} ${response.statusText}`;
                    }
                }
                throw new Error(errorMessage);
            }

            const data = await response.json();
            console.log('Extraction result:', data);

            showReExtractResult(data);

            // If successful, reload the table to show updated data
            if (data.success) {
                extractionsTable.ajax.reload(null, false); // false = don't reset pagination
            }
        } catch (error) {
            console.error('Re-extraction error:', error);
            let errorMessage = 'Network error: Failed to connect to server';
            
            if (error.message) {
                errorMessage = error.message;
            } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                errorMessage = 'Network error: Could not reach server. Please check if the server is running.';
            } else if (error.name === 'SyntaxError') {
                errorMessage = 'Server error: Invalid response format. Please check server logs.';
            }
            
            showReExtractResult({
                success: false,
                message: errorMessage
            });
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    function showReExtractResult(data) {
        const modalElement = document.getElementById('re-extract-modal');
        const modal = new bootstrap.Modal(modalElement);
        const content = document.getElementById('re-extract-content');

        let html = '';

        if (data.success) {
            html += `<div class="alert alert-success">✅ ${data.message || 'Re-extração concluída com sucesso!'}</div>`;

            if (data.extraction) {
                html += `
                <div class="extraction-details">
                    <h5 class="mt-3">Novos Dados da Extração</h5>
                    <table class="table table-sm">
                        <tr><th style="width: 30%;">Resumo</th><td>${data.extraction.summary || 'N/A'}</td></tr>
                        <tr><th>Nome da Vítima</th><td>${data.extraction.victim_name || 'N/A'}</td></tr>
                        <tr><th>Localização</th><td>${data.extraction.location || 'N/A'}</td></tr>
                        <tr><th>Data</th><td>${data.extraction.date || 'N/A'}</td></tr>
                        <tr><th>Mortos</th><td>${data.extraction.death_count !== null && data.extraction.death_count !== undefined ? data.extraction.death_count : 'N/A'}</td></tr>
                        <tr><th>Confiança</th><td>${data.extraction.confidence ? Math.round(data.extraction.confidence * 100) + '%' : 'N/A'}</td></tr>
                    </table>
                    ${data.extraction.keywords_matched ? `<p class="mt-3"><strong>Palavras-chave encontradas:</strong> ${data.extraction.keywords_matched.join(', ')}</p>` : ''}
                </div>
                <p class="text-muted mt-3 small">A página será recarregada em 2 segundos para mostrar os dados atualizados...</p>
            `;
            }
        } else {
            html += `<div class="alert alert-danger">❌ ${data.message || 'Re-extração falhou.'}</div>`;
        }

        content.innerHTML = html;
        modal.show();
    }
</script>

{% endblock %}