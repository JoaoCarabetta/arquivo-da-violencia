{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">News Sources</h2>

<div class="table-container">
    <div class="table-responsive">
        <table id="sources-table" class="table table-hover sources-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Source Type</th>
                    <th>Status</th>
                    <th>Fetched At</th>
                    <th>URL</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be loaded via DataTables AJAX -->
            </tbody>
        </table>
    </div>
</div>

<script>
var sourcesTable;

document.addEventListener('DOMContentLoaded', function() {
    if (typeof $ === 'undefined') {
        console.error('jQuery is not loaded');
        return;
    }
    sourcesTable = $('#sources-table').DataTable({
        serverSide: true,
        ajax: {
            url: '/api/data/sources',
            type: 'GET'
        },
        columns: [
            { data: 'id' },
            { data: 'title' },
            {
                data: 'source_type',
                render: function(data, type, row) {
                    return '<span class="badge badge-type">' + (data || 'unknown') + '</span>';
                }
            },
            {
                data: 'status',
                render: function(data, type, row) {
                    return '<span class="badge badge-' + (data || 'pending') + '">' + (data || 'pending') + '</span>';
                }
            },
            { data: 'fetched_at' },
            {
                data: 'url_link',
                render: function(data, type, row) {
                    if (data && data !== 'N/A') {
                        return '<a href="' + data + '" target="_blank" rel="noopener noreferrer" class="link-primary">View</a>';
                    }
                    return 'N/A';
                }
            },
            {
                data: 'id',
                orderable: false,
                render: function(data, type, row) {
                    return '<button class="btn btn-primary btn-sm" onclick="extractEvent(' + data + ')" id="btn-' + data + '">Extract</button>';
                }
            }
        ],
        order: [[4, 'desc']], // Default sort by fetched_at descending
        pageLength: 25,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
        },
        responsive: true
    });
});

<!-- Result Modal -->
<div class="modal fade" id="result-modal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalLabel">Extraction Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="result-content"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    async function extractEvent(sourceId) {
        const btn = document.getElementById(`btn-${sourceId}`);
        const originalText = btn.textContent;
        btn.textContent = 'Extracting...';
        btn.disabled = true;

        try {
            const response = await fetch(`/api/extract/${sourceId}`, {
                method: 'POST'
            });
            const data = await response.json();

            showResult(data);

            // Update row status if successful - reload the table to reflect changes
            if (data.success) {
                sourcesTable.ajax.reload(null, false); // false = don't reset pagination
            }
        } catch (error) {
            showResult({
                success: false,
                message: 'Network error: ' + error.message
            });
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    function showResult(data) {
        const modalElement = document.getElementById('result-modal');
        const modal = new bootstrap.Modal(modalElement);
        const content = document.getElementById('result-content');

        let html = '';

        if (data.success) {
            html += `<div class="alert alert-success">✅ ${data.message}</div>`;

            if (data.extraction) {
                html += `
                <div class="extraction-details">
                    <h5 class="mt-3">Extracted Data</h5>
                    <table class="table table-sm">
                        <tr><th>Summary</th><td>${data.extraction.summary || 'N/A'}</td></tr>
                        <tr><th>Victim Name</th><td>${data.extraction.victim_name || 'N/A'}</td></tr>
                        <tr><th>Location</th><td>${data.extraction.location || 'N/A'}</td></tr>
                        <tr><th>Date</th><td>${data.extraction.date || 'N/A'}</td></tr>
                        <tr><th>Confidence</th><td>${(data.extraction.confidence * 100).toFixed(0)}%</td></tr>
                    </table>
                    ${data.extraction.keywords_matched ? `<p><strong>Keywords matched:</strong> ${data.extraction.keywords_matched.join(', ')}</p>` : ''}
                </div>
            `;
            }
        } else {
            html += `<div class="alert alert-danger">❌ ${data.message}</div>`;
        }

        content.innerHTML = html;
        modal.show();
    }
</script>
{% endblock %}